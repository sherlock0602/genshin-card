<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç¥é¢¨æ ¼éŸ³å¾‹å¡ç‰‡ - å¯èª¿å­—é«”ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            /* åŸç¥ UI é…è‰²ç›¤ */
            --genshin-bg: #1c2541;       
            --genshin-card-bg: #f4f3ea;  
            --genshin-gold: #d4a024;     
            --genshin-gold-light: #f8d768; 
            --genshin-blue-accent: #395385; 
            --text-color: #4a3b3b;       
            --shadow-color: rgba(0, 0, 0, 0.5);
        }
        body {
            background-color: var(--genshin-bg);
            background-image: 
                radial-gradient(circle at 20% 30%, #2a3d66 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, #395385 0%, transparent 50%);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            margin: 0; height: 100vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden; position: relative; color: var(--genshin-card-bg);
        }

        #main-ui {
            display: flex; flex-direction: column; align-items: center;
            gap: 20px; z-index: 10; width: 100%;
        }

        /* === åŸç¥é¢¨æ ¼å¡ç‰‡ === */
        #genshin-card {
            width: 85vw; max-width: 650px;
            min-height: 420px;
            background-color: var(--genshin-card-bg);
            border: 4px solid var(--genshin-gold);
            outline: 6px solid var(--genshin-blue-accent);
            border-radius: 20px;
            box-shadow: 0 25px 50px var(--shadow-color), inset 0 0 30px rgba(212, 160, 36, 0.2);
            padding: 40px 50px; 
            box-sizing: border-box;
            position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        #genshin-card::before, #genshin-card::after {
            content: ''; position: absolute; width: 60px; height: 60px;
            border: 4px solid var(--genshin-gold); opacity: 0.6; pointer-events: none;
        }
        #genshin-card::before { top: 10px; left: 10px; border-right: none; border-bottom: none; }
        #genshin-card::after { bottom: 10px; right: 10px; border-left: none; border-top: none; }

        /* === åœ–ç‰‡æ¨£å¼ === */
        .chibi-char {
            position: absolute;
            width: 120px; height: auto;
            z-index: 5; opacity: 0.9;
            pointer-events: none;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
        }
        .char-left { bottom: 15px; left: 15px; transform: rotate(-5deg); }
        .char-right { bottom: 15px; right: 15px; transform: rotate(5deg); }

        #editor {
            flex-grow: 1;
            /* é è¨­å­—é«”å¤§å°ï¼Œæœƒè¢« JS è¦†è“‹ */
            font-size: 26px; 
            line-height: 1.6; 
            color: var(--text-color);
            outline: none; white-space: pre-wrap; overflow-y: auto;
            border: none; background: transparent; resize: none;
            text-align: left; 
            z-index: 10; position: relative;
            font-weight: bold;
        }
        
        #editor::-webkit-scrollbar { width: 6px; }
        #editor::-webkit-scrollbar-thumb { background: var(--genshin-gold); border-radius: 10px; }
        #editor:empty::before { content: "åœ¨æ­¤å¯«ä¸‹ä½ çš„å†’éšªè©©ç¯‡..."; color: #a8978a; }

        /* === æ§åˆ¶å€ (æ»‘æ¡¿ + æŒ‰éˆ•) === */
        #controls-container {
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            width: 100%;
        }

        /* === å­—é«”èª¿æ•´æ»‘æ¡¿ === */
        .slider-group {
            display: flex; align-items: center; gap: 15px;
            background: rgba(28, 37, 65, 0.8);
            padding: 8px 20px; border-radius: 30px;
            border: 1px solid var(--genshin-gold);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .slider-label { font-size: 14px; color: var(--genshin-gold-light); font-weight: bold; letter-spacing: 1px; }
        
        /* è‡ªè¨‚æ»‘æ¡¿æ¨£å¼ */
        input[type=range] {
            -webkit-appearance: none; width: 150px; height: 6px;
            background: #2d3e5e; border-radius: 5px; outline: none;
            border: 1px solid #5b77af;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px; border-radius: 50%;
            background: var(--genshin-gold);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
            border: 2px solid #fff;
        }
        input[type=range]::-moz-range-thumb {
            width: 18px; height: 18px; border-radius: 50%;
            background: var(--genshin-gold);
            cursor: pointer; border: 2px solid #fff;
        }

        /* === æŒ‰éˆ•å€ === */
        #controls { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        button {
            background: linear-gradient(to bottom, #4a6291, #2d3e5e);
            color: var(--genshin-gold-light);
            border: 2px solid var(--genshin-gold);
            padding: 12px 35px; font-size: 18px; font-family: inherit; cursor: pointer;
            border-radius: 50px; transition: all 0.2s; outline: none; white-space: nowrap; 
            letter-spacing: 1px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), inset 0 2px 5px rgba(255,255,255,0.2);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        button:hover { 
            background: linear-gradient(to bottom, #5b77af, #395385); color: white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4); transform: translateY(-2px);
            border-color: var(--genshin-gold-light);
        }
        button:active { transform: translateY(0px); }
        button:disabled { background: #333; color: #777; border-color: #555; cursor: default; transform: none; box-shadow: none;}
        .btn-record { background: linear-gradient(to bottom, #cc3c31, #8a251e); border-color: #ffbba6;}
        .btn-record:hover { background: linear-gradient(to bottom, #e64b3e, #a83229); }
        
        /* === è¦†è“‹å±¤ === */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(28, 37, 65, 0.95); z-index: 100; 
            display: none; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; box-sizing: border-box; color: var(--genshin-gold-light);
        }
        .overlay h2 { color: var(--genshin-gold); margin-bottom: 30px; font-weight: bold; font-size: 28px; text-shadow: 0 2px 5px black;}
        .close-btn { margin-top: 30px; border-color: var(--genshin-gold); color: var(--genshin-gold); background: transparent;}
        .close-btn:hover { background: var(--genshin-gold); color: #1c2541; }
        #qrcode-display { padding: 20px; background: var(--genshin-card-bg); border-radius: 15px; border: 4px solid var(--genshin-gold); }

        #receiver-overlay .open-letter-btn {
            font-size: 24px; padding: 18px 50px; animation: magic-pulse 2s infinite;
        }
        @keyframes magic-pulse {
            0% { box-shadow: 0 0 0 0 rgba(212, 160, 36, 0.6); }
            70% { box-shadow: 0 0 0 25px rgba(212, 160, 36, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 160, 36, 0); }
        }
        #postcard-canvas { position: absolute; top: -9999px; left: -9999px; }
    </style>
</head>
<body>

    <div id="main-ui">
        <div id="genshin-card">
            <img src="paimon.png" id="img-paimon" class="chibi-char char-left" alt="paimon">
            <img src="traveler.png" id="img-traveler" class="chibi-char char-right" alt="traveler">

            <div id="editor" contenteditable="true"></div>
        </div>

        <div id="controls-container">
            <div class="slider-group">
                <span class="slider-label" style="font-size: 12px;">A-</span>
                <input type="range" id="font-size-slider" min="16" max="50" value="26">
                <span class="slider-label" style="font-size: 18px;">A+</span>
            </div>

            <div id="controls">
                <button id="play-btn">â–¶ è†è½</button>
                <button id="record-btn" class="btn-record">ğŸ”´ éŒ„è£½ç´€éŒ„</button>
                <button id="share-btn" class="btn-share">âœ¦ åˆ†äº«</button>
            </div>
        </div>
    </div>

    <div id="share-overlay" class="overlay">
        <h2>æƒæå‚³é€é€™ä»½å†’éšªç´€éŒ„ âœ¦</h2>
        <div id="qrcode-display"></div>
        <p style="color: #a8978a; margin-top: 20px; font-size: 16px;">(æ‰‹æ©Ÿæƒæå¾Œæœƒé–‹å•ŸåŸç¥é¢¨æ ¼å¡ç‰‡)</p>
        <button class="close-btn" onclick="closeOverlay('share-overlay')">é—œé–‰</button>
    </div>

    <div id="receiver-overlay" class="overlay">
        <h2>æ”¶åˆ°ä¸€ä»½ã€Œæç“¦ç‰¹çš„ä¿¡ä»¶ã€</h2>
        <p style="color:#a8978a; margin-bottom: 30px; font-size: 18px;">è«‹æ‰“é–‹è²éŸ³ï¼Œé»æ“Šé–‹å•Ÿ</p>
        <button id="open-letter-btn" class="open-letter-btn">é–‹å•Ÿä¿¡ä»¶ âœ¦</button>
    </div>

    <canvas id="postcard-canvas" width="1200" height="800"></canvas>

    <script>
        // éŸ³æ•ˆ
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        const dest = audioCtx.createMediaStreamDestination();
        const notes = [196.00, 220.00, 261.63, 293.66, 329.63, 392.00, 440.00, 523.25, 587.33, 659.25, 783.99, 880.00, 1046.50, 1174.66, 1318.51];
        
        function playSound(char) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'sine';
            let index = char ? (char.charCodeAt(0) % notes.length) : Math.floor(Math.random() * notes.length);
            osc.frequency.setValueAtTime(notes[index], audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination); gain.connect(dest);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime + 0.03);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.0);
            osc.start(); osc.stop(audioCtx.currentTime + 1.0);
        }
        
        function triggerEffect(char) {
            playSound(char);
            if (this.lastFire && Date.now() - this.lastFire < 80) return;
            this.lastFire = Date.now();
            const sel = window.getSelection();
            if (sel.rangeCount) {
                const rect = sel.getRangeAt(0).getBoundingClientRect();
                if (rect && rect.left) {
                    confetti({
                        particleCount: 8, spread: 60, origin: { x: rect.left/window.innerWidth, y: rect.top/window.innerHeight },
                        colors: ['#d4a024', '#75c2a8', '#cfa726', '#a757cb', '#4991e4', '#cc3c31', '#a0e3de', '#ffffff'], 
                        shapes: ['circle', 'star'], scalar: 0.8, gravity: 0.6, ticks: 40, disableForReducedMotion: true
                    });
                }
            }
        }

        // å­—é«”æ§åˆ¶é‚è¼¯
        const editor = document.getElementById('editor');
        const fontSizeSlider = document.getElementById('font-size-slider');

        // ç›£è½æ»‘æ¡¿æ”¹è®Š
        fontSizeSlider.addEventListener('input', (e) => {
            const newSize = e.target.value;
            editor.style.fontSize = newSize + 'px';
        });

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));
        let isPlaying = false;
        async function startAutoPlay(text, mode = 'preview') {
            if (isPlaying) return; isPlaying = true;
            const buttons = document.querySelectorAll('#controls button');
            buttons.forEach(b => b.disabled = true);
            if(mode === 'preview') document.getElementById('play-btn').innerText = "æ¼”å¥ä¸­...";
            editor.innerText = ""; editor.focus(); await sleep(500);
            for (let char of Array.from(text)) {
                if (!isPlaying) break;
                editor.innerText += char;
                const range = document.createRange(); range.selectNodeContents(editor); range.collapse(false);
                const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
                if (char.trim()) triggerEffect(char);
                editor.scrollTop = editor.scrollHeight;
                let delay = ['ï¼Œ', 'ã€‚', 'ï¼', 'ï¼Ÿ', '\n', 'â‹¯'].includes(char) ? 450 : (130 + Math.random() * 50);
                if (mode === 'recording') delay += 60;
                await sleep(delay);
            }
            await sleep(1200);
            if (mode !== 'receiver_loop') {
                isPlaying = false; buttons.forEach(b => b.disabled = false); document.getElementById('play-btn').innerText = "â–¶ è†è½";
            }
        }

        const canvas = document.getElementById('postcard-canvas');
        const ctx = canvas.getContext('2d');
        const recordBtn = document.getElementById('record-btn');
        recordBtn.addEventListener('click', async () => {
            const text = editor.innerText.trim();
            if (!text) return alert("è«‹å…ˆå¯«ä¸‹ä½ çš„å†’éšªç´€éŒ„ï¼âœ¦");
            recordBtn.innerText = "æº–å‚™éŒ„è£½...";
            
            // æŠ“å–ç•¶å‰çš„å­—é«”å¤§å°å‚³çµ¦ç¹ªåœ–å‡½å¼
            const currentFontSize = parseInt(window.getComputedStyle(editor).fontSize);
            
            drawGenshinCard(text, currentFontSize); 
            
            const canvasStream = canvas.captureStream(0);
            const track = canvasStream.getVideoTracks()[0];
            const refresher = setInterval(() => { if(track.requestFrame) track.requestFrame(); }, 500);
            const combinedStream = new MediaStream([...canvasStream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
            let options = { mimeType: 'video/webm;codecs=vp9' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };
            const recorder = new MediaRecorder(combinedStream, options);
            const chunks = [];
            recorder.ondataavailable = (e) => { if(e.data.size > 0) chunks.push(e.data); };
            recorder.onstop = () => {
                clearInterval(refresher);
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'genshin-record.webm'; a.click();
                URL.revokeObjectURL(url);
                recordBtn.innerText = "ğŸ”´ éŒ„è£½ç´€éŒ„"; editor.innerText = text;
            };
            recorder.start();
            recordBtn.innerText = "éŒ„è£½ä¸­...è«‹å‹¿åˆ‡æ›";
            await startAutoPlay(text, 'recording');
            recorder.stop();
        });

        // ç•«å‡ºåŸç¥é¢¨æ ¼å¡ç‰‡ (æ”¯æ´å‹•æ…‹å­—é«”å¤§å°)
        function drawGenshinCard(text, uiFontSize) {
            const w = canvas.width, h = canvas.height;
            // 1. èƒŒæ™¯
            const grad = ctx.createLinearGradient(0, 0, w, h);
            grad.addColorStop(0, "#1c2541"); grad.addColorStop(1, "#2a3d66");
            ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h);
            
            // 2. å¡ç‰‡æœ¬é«”
            const cardX = 100, cardY = 80, cardW = w-200, cardH = h-160;
            ctx.fillStyle = "#f4f3ea";
            roundRect(ctx, cardX, cardY, cardW, cardH, 30, true, false);
            
            // 3. é‚Šæ¡†
            ctx.lineWidth = 8; ctx.strokeStyle = "#395385"; 
            roundRect(ctx, cardX-4, cardY-4, cardW+8, cardH+8, 34, false, true);
            ctx.lineWidth = 5; ctx.strokeStyle = "#d4a024";
            roundRect(ctx, cardX, cardY, cardW, cardH, 30, false, true);

            // 4. æ–‡å­— (å·¦å°é½Šï¼Œå‹•æ…‹å¤§å°)
            // Canvas è§£æåº¦è¼ƒé«˜ï¼Œæ‰€ä»¥æˆ‘å€‘è¦æŠŠç¶²é ä¸Šçš„å­—é«”å¤§å°æ”¾å¤§ä¸€é»é» (ç´„ 1.5 å€) æ‰æœƒæ¸…æ™°
            const canvasFontSize = uiFontSize * 1.5; 
            const lineHeight = canvasFontSize * 1.6; // è¡Œè·

            ctx.fillStyle = "#4a3b3b"; 
            ctx.font = `bold ${canvasFontSize}px 'Palatino Linotype', serif`; 
            ctx.textAlign = "left"; ctx.textBaseline = "top";
            
            const lines = text.split('\n');
            let y = cardY + 80;
            const startX = cardX + 80;
            
            // è¨ˆç®—æ¯è¡Œæœ€å¤§å­—æ•¸ (å¤§æ¦‚ä¼°ç®—ï¼Œé˜²æ­¢å¤ªå¯¬)
            const maxCharsPerLine = Math.floor((cardW - 160) / (canvasFontSize * 0.6));

            lines.forEach(line => {
                // ç°¡å–®æˆªæ–·
                let displayLine = line.length > maxCharsPerLine ? line.substring(0, maxCharsPerLine) + "..." : line;
                ctx.fillText(displayLine, startX, y); 
                y += lineHeight; // å‹•æ…‹è¡Œè·
            });

            // 5. ç¹ªè£½åœ–ç‰‡
            const imgPaimon = document.getElementById('img-paimon');
            const imgTraveler = document.getElementById('img-traveler');
            if (imgPaimon && imgPaimon.complete) {
                ctx.save();
                ctx.translate(cardX + 80, cardY + cardH - 80); 
                ctx.rotate(-5 * Math.PI / 180); 
                ctx.drawImage(imgPaimon, -90, -90, 180, 180); 
                ctx.restore();
            }
            if (imgTraveler && imgTraveler.complete) {
                ctx.save();
                ctx.translate(cardX + cardW - 80, cardY + cardH - 80); 
                ctx.rotate(5 * Math.PI / 180); 
                ctx.drawImage(imgTraveler, -90, -90, 180, 180);
                ctx.restore();
            }
            
            // åº•éƒ¨å°å­—
            ctx.textAlign = "center";
            ctx.fillStyle = "#d4a024"; ctx.font = "24px serif"; 
            ctx.fillText("âœ¦ Genshin Impact Musical Record âœ¦", w/2, h - 50);
        }

        function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
            ctx.beginPath(); ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y); ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius); ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height); ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius); ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath(); if (fill) ctx.fill(); if (stroke) ctx.stroke();
        }

        const shareBtn = document.getElementById('share-btn');
        const shareOverlay = document.getElementById('share-overlay');
        const qrDisplay = document.getElementById('qrcode-display');
        shareBtn.addEventListener('click', () => {
            const text = editor.innerText.trim();
            if (!text) return alert("è«‹å…ˆå¯«é»æ±è¥¿å†åˆ†äº«å–”ï¼âœ¦");
            if (window.location.protocol === 'file:') return alert("è«‹å°‡ç¶²é ä¸Šå‚³åˆ°ä¼ºæœå™¨æ‰èƒ½ä½¿ç”¨åˆ†äº«åŠŸèƒ½å–”ï¼");
            const encodedText = encodeURIComponent(text);
            // å‚³éå­—é«”å¤§å°åƒæ•¸
            const currentSize = fontSizeSlider.value;
            const shareUrl = `${window.location.origin}${window.location.pathname}?letter=${encodedText}&size=${currentSize}`;
            
            qrDisplay.innerHTML = ""; 
            new QRCode(qrDisplay, { text: shareUrl, width: 250, height: 250, colorDark: "#4a3b3b", colorLight: "#f4f3ea" });
            shareOverlay.style.display = 'flex';
        });
        function closeOverlay(id) { document.getElementById(id).style.display = 'none'; }
        
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const letterContent = params.get('letter');
            const sizeParam = params.get('size'); // è®€å–åˆ†äº«éä¾†çš„å­—é«”å¤§å°

            if (letterContent) {
                const decodedText = decodeURIComponent(letterContent);
                // å¥—ç”¨åˆ†äº«çš„å­—é«”å¤§å°
                if(sizeParam) editor.style.fontSize = sizeParam + 'px';
                
                document.getElementById('main-ui').style.display = 'none';
                document.getElementById('receiver-overlay').style.display = 'flex';
                document.getElementById('open-letter-btn').addEventListener('click', async () => {
                    document.getElementById('receiver-overlay').style.display = 'none';
                    document.getElementById('main-ui').style.display = 'flex';
                    // éš±è—ç·¨è¼¯æ§åˆ¶é …ï¼Œåªç•™å¡ç‰‡
                    document.getElementById('controls-container').style.display = 'none';
                    editor.setAttribute('contenteditable', 'false');
                    while(true) { await startAutoPlay(decodedText, 'receiver_loop'); await sleep(2500); }
                });
            }
        });

        document.getElementById('play-btn').addEventListener('click', () => startAutoPlay(editor.innerText));
        const ignoredKeys = new Set(['Shift', 'Control', 'Alt', 'Meta', 'Tab', 'Escape', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight']);
        editor.addEventListener('keydown', (e) => {
            if (isPlaying || editor.getAttribute('contenteditable') === 'false') { e.preventDefault(); return; }
            if (ignoredKeys.has(e.key)) return; triggerEffect(e.key);
        });
        editor.addEventListener('compositionend', (e) => { if (!isPlaying) triggerEffect(e.data.slice(-1)); });
        document.getElementById('genshin-card').addEventListener('click', () => { editor.focus(); });
    </script>
</body>
</html>
