<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç¥é¢¨æ ¼éŸ³å¾‹å¡ç‰‡ - å®Œç¾é‹¼ç´ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --genshin-bg: #1c2541;       
            --genshin-card-bg: #f4f3ea;  
            --genshin-gold: #d4a024;     
            --genshin-gold-light: #f8d768; 
            --genshin-blue-accent: #395385; 
            --text-color: #4a3b3b;       
            --shadow-color: rgba(0, 0, 0, 0.5);
        }
        body {
            background-color: var(--genshin-bg);
            background-image: 
                radial-gradient(circle at 20% 30%, #2a3d66 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, #395385 0%, transparent 50%);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            margin: 0; height: 100vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden; position: relative; color: var(--genshin-card-bg);
        }

        #main-ui {
            display: flex; flex-direction: column; align-items: center;
            gap: 20px; z-index: 10; width: 100%;
        }

        #genshin-card {
            width: 85vw; max-width: 650px;
            min-height: 420px;
            background-color: var(--genshin-card-bg);
            border: 4px solid var(--genshin-gold);
            outline: 6px solid var(--genshin-blue-accent);
            border-radius: 20px;
            box-shadow: 0 25px 50px var(--shadow-color), inset 0 0 30px rgba(212, 160, 36, 0.2);
            padding: 40px 50px; 
            box-sizing: border-box;
            position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        #genshin-card::before, #genshin-card::after {
            content: ''; position: absolute; width: 60px; height: 60px;
            border: 4px solid var(--genshin-gold); opacity: 0.6; pointer-events: none;
        }
        #genshin-card::before { top: 10px; left: 10px; border-right: none; border-bottom: none; }
        #genshin-card::after { bottom: 10px; right: 10px; border-left: none; border-top: none; }

        .chibi-char {
            position: absolute; width: 120px; height: auto;
            z-index: 5; opacity: 0.9; pointer-events: none;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
        }
        .char-left { bottom: 15px; left: 15px; transform: rotate(-5deg); }
        .char-right { bottom: 15px; right: 15px; transform: rotate(5deg); }

        #editor {
            flex-grow: 1; font-size: 26px; line-height: 1.6; 
            color: var(--text-color); outline: none; white-space: pre-wrap; overflow-y: auto;
            border: none; background: transparent; resize: none; text-align: left; 
            z-index: 10; position: relative; font-weight: bold;
        }
        #editor::-webkit-scrollbar { width: 6px; }
        #editor::-webkit-scrollbar-thumb { background: var(--genshin-gold); border-radius: 10px; }
        #editor:empty::before { content: "æ—…è¡Œè€…ï¼Œ\nè«‹å˜—è©¦æŒ‰ä¸‹ A-S-D-F æ¼”å¥..."; color: #a8978a; }

        /* ç‰¹æ•ˆç•«å¸ƒ */
        #effect-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 20;
        }

        /* æ§åˆ¶å€ */
        #controls-container {
            display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%;
        }
        .slider-group {
            display: flex; align-items: center; gap: 15px;
            background: rgba(28, 37, 65, 0.8);
            padding: 8px 20px; border-radius: 30px;
            border: 1px solid var(--genshin-gold);
        }
        .slider-label { font-size: 14px; color: var(--genshin-gold-light); font-weight: bold; }
        input[type=range] {
            -webkit-appearance: none; width: 150px; height: 6px;
            background: #2d3e5e; border-radius: 5px; outline: none; border: 1px solid #5b77af;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%;
            background: var(--genshin-gold); cursor: pointer; border: 2px solid #fff;
        }

        #controls { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        button {
            background: linear-gradient(to bottom, #4a6291, #2d3e5e);
            color: var(--genshin-gold-light); border: 2px solid var(--genshin-gold);
            padding: 12px 35px; font-size: 18px; font-family: inherit; cursor: pointer;
            border-radius: 50px; transition: all 0.2s; outline: none; white-space: nowrap; 
            letter-spacing: 1px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        button:hover { 
            background: linear-gradient(to bottom, #5b77af, #395385); color: white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4); transform: translateY(-2px);
            border-color: var(--genshin-gold-light);
        }
        button:disabled { background: #333; color: #777; border-color: #555; cursor: default; transform: none; box-shadow: none;}
        .btn-record { background: linear-gradient(to bottom, #cc3c31, #8a251e); border-color: #ffbba6;}
        .btn-record:hover { background: linear-gradient(to bottom, #e64b3e, #a83229); }
        
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(28, 37, 65, 0.95); z-index: 100; 
            display: none; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: var(--genshin-gold-light);
        }
        .overlay h2 { color: var(--genshin-gold); margin-bottom: 30px; font-size: 28px; }
        .close-btn { margin-top: 30px; border-color: var(--genshin-gold); color: var(--genshin-gold); background: transparent;}
        .close-btn:hover { background: var(--genshin-gold); color: #1c2541; }
        #qrcode-display { padding: 20px; background: var(--genshin-card-bg); border-radius: 15px; border: 4px solid var(--genshin-gold); }
        
        #receiver-overlay .open-letter-btn {
            font-size: 24px; padding: 18px 50px; animation: magic-pulse 2s infinite;
        }
        @keyframes magic-pulse {
            0% { box-shadow: 0 0 0 0 rgba(212, 160, 36, 0.6); }
            70% { box-shadow: 0 0 0 25px rgba(212, 160, 36, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 160, 36, 0); }
        }

        #postcard-canvas { position: absolute; top: -9999px; left: -9999px; }
    </style>
</head>
<body>

    <div id="main-ui">
        <div id="genshin-card">
            <img src="paimon.png" id="img-paimon" class="chibi-char char-left" alt="paimon">
            <img src="traveler.png" id="img-traveler" class="chibi-char char-right" alt="traveler">
            
            <div id="editor" contenteditable="true"></div>
            <canvas id="effect-overlay"></canvas>
        </div>

        <div id="controls-container">
            <div class="slider-group">
                <span class="slider-label" style="font-size: 12px;">A-</span>
                <input type="range" id="font-size-slider" min="16" max="50" value="26">
                <span class="slider-label" style="font-size: 18px;">A+</span>
            </div>
            <div id="controls">
                <button id="play-btn">â–¶ è†è½</button>
                <button id="record-btn" class="btn-record">ğŸ”´ éŒ„è£½ç´€éŒ„</button>
                <button id="share-btn" class="btn-share">âœ¦ åˆ†äº«</button>
            </div>
        </div>
    </div>

    <div id="share-overlay" class="overlay">
        <h2>æƒæå‚³é€é€™ä»½å†’éšªç´€éŒ„ âœ¦</h2>
        <div id="qrcode-display"></div>
        <p style="color: #a8978a; margin-top: 20px; font-size: 16px;">(æ‰‹æ©Ÿæƒæå¾Œæœƒé–‹å•ŸåŸç¥é¢¨æ ¼å¡ç‰‡)</p>
        <button class="close-btn" onclick="closeOverlay('share-overlay')">é—œé–‰</button>
    </div>
    <div id="receiver-overlay" class="overlay">
        <h2>æ”¶åˆ°ä¸€ä»½ã€Œæç“¦ç‰¹çš„ä¿¡ä»¶ã€</h2>
        <p style="color:#a8978a; margin-bottom: 30px; font-size: 18px;">è«‹æ‰“é–‹è²éŸ³ï¼Œé»æ“Šé–‹å•Ÿ</p>
        <button id="open-letter-btn" class="open-letter-btn">é–‹å•Ÿä¿¡ä»¶ âœ¦</button>
    </div>

    <canvas id="postcard-canvas" width="1200" height="800"></canvas>

    <script>
        // ==========================================
        // 1. ç‰©ç†æŒ‰éµæ˜ å°„ç³»çµ± (ä½¿ç”¨ e.code)
        // ==========================================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        const dest = audioCtx.createMediaStreamDestination();

        // ä½¿ç”¨ "KeyX" æ ¼å¼çš„ç‰©ç†ä»£ç¢¼ï¼Œç¢ºä¿ä¸­æ–‡è¼¸å…¥æ³•ä¸‹ä¹Ÿèƒ½æ­£ç¢ºå°æ‡‰
        const keyMap = {
            'KeyZ': 130.81, 'KeyX': 146.83, 'KeyC': 164.81, 'KeyV': 174.61, 'KeyB': 196.00, 'KeyN': 220.00, 'KeyM': 246.94, // ä½éŸ³
            'KeyA': 261.63, 'KeyS': 293.66, 'KeyD': 329.63, 'KeyF': 349.23, 'KeyG': 392.00, 'KeyH': 440.00, 'KeyJ': 493.88, 'KeyK': 523.25, 'KeyL': 587.33, // ä¸­éŸ³
            'KeyQ': 523.25, 'KeyW': 587.33, 'KeyE': 659.25, 'KeyR': 698.46, 'KeyT': 783.99, 'KeyY': 880.00, 'KeyU': 987.77, 'KeyI': 1046.50, 'KeyO': 1174.66, 'KeyP': 1318.51, // é«˜éŸ³
            'Digit1': 1046.50, 'Digit2': 1174.66, 'Digit3': 1318.51, 'Digit4': 1396.91, 'Digit5': 1567.98, 'Digit6': 1760.00, 'Digit7': 1975.53 // è¶…é«˜éŸ³
        };
        // æ’­æ”¾æ™‚ä½¿ç”¨çš„å‚™ç”¨é »ç‡è¡¨ (å› ç‚ºæ’­æ”¾åªæœ‰å­—å…ƒæ²’æœ‰æŒ‰éµç¢¼)
        const defaultNotes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];

        function playSound(input) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); 
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            
            let freq;
            // é‚è¼¯åˆ¤æ–·ï¼šå¦‚æœæ˜¯ "KeyA" é€™ç¨®é•·åº¦çš„å­—ä¸²ï¼ŒæŸ¥ç‰©ç†è¡¨ï¼›å¦å‰‡æŸ¥å­—å…ƒé›œæ¹Š
            if (input && input.length > 1 && keyMap[input]) {
                freq = keyMap[input]; // æ‰“å­—æ™‚ï¼šç²¾æº–ç‰©ç†å°æ‡‰
            } else if (input && input.length === 1) {
                // æ’­æ”¾æ¨¡å¼/è¼¸å…¥æ³•é¸å­—ç¢ºèªæ™‚ï¼šç”¨å­—å…ƒä»£ç¢¼é›œæ¹Šï¼Œç¢ºä¿åŒä¸€å­—éŸ³é«˜å›ºå®š
                freq = defaultNotes[input.charCodeAt(0) % defaultNotes.length];
            } else {
                freq = defaultNotes[Math.floor(Math.random() * defaultNotes.length)];
            }

            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination); gain.connect(dest);
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.2);

            osc.start(); osc.stop(audioCtx.currentTime + 1.2);
        }

        // ==========================================
        // 2. éŸ³ç¬¦ç‰¹æ•ˆ (åœç•™æ™‚é–“åŠ é•·)
        // ==========================================
        const overlayCanvas = document.getElementById('effect-overlay');
        const overlayCtx = overlayCanvas.getContext('2d');
        let particles = [];
        const noteSymbols = ['â™ª', 'â™«', 'â™©', 'â™¬', 'â™­', 'â™®', 'â™¯'];
        const colors = ['#d4a024', '#75c2a8', '#cfa726', '#a757cb', '#4991e4', '#cc3c31'];

        function resizeOverlay() {
            const card = document.getElementById('genshin-card');
            overlayCanvas.width = card.clientWidth;
            overlayCanvas.height = card.clientHeight;
        }
        window.addEventListener('resize', resizeOverlay);
        resizeOverlay();

        class NoteParticle {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.text = noteSymbols[Math.floor(Math.random() * noteSymbols.length)];
                this.color = colors[Math.floor(Math.random() * colors.length)];
                this.size = 24 + Math.random() * 10;
                this.speedY = -0.8 - Math.random() * 1.0; // é£„æ…¢ä¸€é»
                this.speedX = (Math.random() - 0.5) * 1.5;
                this.alpha = 1;
                this.rotation = (Math.random() - 0.5) * 0.5;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.alpha -= 0.008; // æ¸›å°‘è¡°æ¸›é€Ÿåº¦ (åŸæœ¬æ˜¯ 0.015)ï¼Œè®“éŸ³ç¬¦å­˜æ´»æ›´ä¹…
                this.size *= 0.995;
            }
            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.font = `bold ${this.size}px serif`;
                ctx.shadowColor = this.color; ctx.shadowBlur = 10;
                ctx.fillText(this.text, 0, 0);
                ctx.restore();
            }
        }

        function animateParticles() {
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw(overlayCtx);
                if (particles[i].alpha <= 0) { particles.splice(i, 1); i--; }
            }
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        function triggerEffect(input) {
            playSound(input);
            const sel = window.getSelection();
            if (sel.rangeCount) {
                const range = sel.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const cardRect = document.getElementById('genshin-card').getBoundingClientRect();
                const x = rect.left - cardRect.left; 
                const y = rect.top - cardRect.top;
                particles.push(new NoteParticle(x, y));
            }
        }

        // ==========================================
        // 3. äº’å‹•èˆ‡äº‹ä»¶ç›£è½ (æ”¹ç”¨ e.code)
        // ==========================================
        const editor = document.getElementById('editor');
        const fontSizeSlider = document.getElementById('font-size-slider');
        
        fontSizeSlider.addEventListener('input', (e) => { editor.style.fontSize = e.target.value + 'px'; });

        // é—œéµä¿®æ”¹ï¼šç›£è½ keydown äº‹ä»¶æ™‚ï¼Œå‚³å…¥ e.code (ç‰©ç†æŒ‰éµ)
        const ignoredKeys = new Set(['Shift', 'Control', 'Alt', 'Meta', 'Tab', 'Escape', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight']);
        
        editor.addEventListener('keydown', (e) => {
            if (isPlaying || editor.getAttribute('contenteditable') === 'false') { 
                if(!ignoredKeys.has(e.key)) e.preventDefault(); 
                return; 
            }
            if (ignoredKeys.has(e.key)) return;
            
            // å‚³å…¥ e.code (å¦‚ "KeyA") è€Œä¸æ˜¯ e.key (å¦‚ "Process" æˆ– "ã„‡")
            triggerEffect(e.code);
        });

        // ç‚ºäº†è®“ä¸­æ–‡é¸å­—ç¢ºèªæ™‚ä¹Ÿæœ‰è²éŸ³ï¼Œä¿ç•™ compositionendï¼Œä½†æ­¤æ™‚åªèƒ½ç”¨å­—å…ƒé›œæ¹Š
        editor.addEventListener('compositionend', (e) => { 
            if (!isPlaying) {
                // é¸å­—å®Œæˆçš„ç¬é–“ï¼Œä¹Ÿå¯ä»¥åŠ ä¸€å€‹éŸ³æ•ˆï¼Œæˆ–æ˜¯é¸æ“‡ä¸åŠ ä»¥å…å¤ªåµ
                // é€™è£¡å‚³å…¥å­—å…ƒï¼Œæœƒèµ°é›œæ¹Šé‚è¼¯
                // triggerEffect(e.data.slice(-1)); 
            }
        });

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));
        let isPlaying = false;

        async function startAutoPlay(text, mode = 'preview') {
            if (isPlaying) return; isPlaying = true;
            const buttons = document.querySelectorAll('#controls button');
            buttons.forEach(b => b.disabled = true);
            if(mode === 'preview') document.getElementById('play-btn').innerText = "æ¼”å¥ä¸­...";
            editor.innerText = ""; editor.focus(); await sleep(500);
            
            for (let char of Array.from(text)) {
                if (!isPlaying) break;
                editor.innerText += char;
                const range = document.createRange(); range.selectNodeContents(editor); range.collapse(false);
                const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
                // æ’­æ”¾æ¨¡å¼åªèƒ½å‚³å­—å…ƒ
                if (char.trim()) triggerEffect(char);
                editor.scrollTop = editor.scrollHeight;
                let delay = ['ï¼Œ', 'ã€‚', '\n'].includes(char) ? 450 : (150 + Math.random() * 50);
                if (mode === 'recording') delay += 60;
                await sleep(delay);
            }
            await sleep(1200);
            if (mode !== 'receiver_loop') {
                isPlaying = false; buttons.forEach(b => b.disabled = false); document.getElementById('play-btn').innerText = "â–¶ è†è½";
            }
        }

        // ==========================================
        // 4. éŒ„å½±åŠŸèƒ½
        // ==========================================
        const canvas = document.getElementById('postcard-canvas');
        const ctx = canvas.getContext('2d');
        const recordBtn = document.getElementById('record-btn');

        recordBtn.addEventListener('click', async () => {
            const text = editor.innerText.trim();
            if (!text) return alert("è«‹å…ˆå¯«ä¸‹ä½ çš„å†’éšªç´€éŒ„ï¼âœ¦");
            recordBtn.innerText = "æº–å‚™éŒ„è£½...";
            
            const currentFontSize = parseInt(window.getComputedStyle(editor).fontSize);
            let recording = true;
            const canvasStream = canvas.captureStream(30); 
            const combinedStream = new MediaStream([...canvasStream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
            
            let options = { mimeType: 'video/webm;codecs=vp9' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };
            const recorder = new MediaRecorder(combinedStream, options);
            const chunks = [];
            
            recorder.ondataavailable = (e) => { if(e.data.size > 0) chunks.push(e.data); };
            recorder.onstop = () => {
                recording = false;
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'genshin-piano-record.webm'; a.click();
                URL.revokeObjectURL(url);
                recordBtn.innerText = "ğŸ”´ éŒ„è£½ç´€éŒ„"; editor.innerText = text;
            };

            function renderLoop() {
                if(!recording) return;
                drawGenshinCard(text, currentFontSize, true); 
                // ç¹ªè£½ç²’å­åˆ°éŒ„å½± Canvas
                ctx.save();
                const scaleX = canvas.width / overlayCanvas.width;
                const scaleY = canvas.height / overlayCanvas.height;
                particles.forEach(p => {
                    ctx.save();
                    ctx.translate(100 + p.x * (canvas.width-200)/overlayCanvas.width, 80 + p.y * (canvas.height-160)/overlayCanvas.height); 
                    ctx.rotate(p.rotation);
                    ctx.globalAlpha = p.alpha;
                    ctx.fillStyle = p.color;
                    ctx.font = `bold ${p.size * 1.5}px serif`;
                    ctx.fillText(p.text, 0, 0);
                    ctx.restore();
                });
                ctx.restore();
                requestAnimationFrame(renderLoop);
            }

            recorder.start();
            renderLoop();
            
            recordBtn.innerText = "éŒ„è£½ä¸­...è«‹å‹¿åˆ‡æ›";
            await startAutoPlay(text, 'recording');
            recorder.stop();
        });

        function drawGenshinCard(fullText, uiFontSize, isRecording) {
            const w = canvas.width, h = canvas.height;
            const grad = ctx.createLinearGradient(0, 0, w, h);
            grad.addColorStop(0, "#1c2541"); grad.addColorStop(1, "#2a3d66");
            ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h);
            
            const cardX = 100, cardY = 80, cardW = w-200, cardH = h-160;
            ctx.fillStyle = "#f4f3ea"; roundRect(ctx, cardX, cardY, cardW, cardH, 30, true, false);
            
            ctx.lineWidth = 8; ctx.strokeStyle = "#395385"; roundRect(ctx, cardX-4, cardY-4, cardW+8, cardH+8, 34, false, true);
            ctx.lineWidth = 5; ctx.strokeStyle = "#d4a024"; roundRect(ctx, cardX, cardY, cardW, cardH, 30, false, true);

            const canvasFontSize = uiFontSize * 1.5; 
            const lineHeight = canvasFontSize * 1.6;
            ctx.fillStyle = "#4a3b3b"; ctx.font = `bold ${canvasFontSize}px 'Palatino Linotype', serif`; 
            ctx.textAlign = "left"; ctx.textBaseline = "top";
            
            const textToDraw = isRecording ? editor.innerText : fullText;
            const lines = textToDraw.split('\n');
            let y = cardY + 80; const startX = cardX + 80;
            const maxCharsPerLine = Math.floor((cardW - 160) / (canvasFontSize * 0.6));

            lines.forEach(line => {
                let displayLine = line.length > maxCharsPerLine ? line.substring(0, maxCharsPerLine) + "..." : line;
                ctx.fillText(displayLine, startX, y); y += lineHeight;
            });

            const imgPaimon = document.getElementById('img-paimon');
            const imgTraveler = document.getElementById('img-traveler');
            if (imgPaimon && imgPaimon.complete) {
                ctx.save(); ctx.translate(cardX + 80, cardY + cardH - 80); ctx.rotate(-5 * Math.PI / 180); 
                ctx.drawImage(imgPaimon, -90, -90, 180, 180); ctx.restore();
            }
            if (imgTraveler && imgTraveler.complete) {
                ctx.save(); ctx.translate(cardX + cardW - 80, cardY + cardH - 80); ctx.rotate(5 * Math.PI / 180); 
                ctx.drawImage(imgTraveler, -90, -90, 180, 180); ctx.restore();
            }
            
            ctx.textAlign = "center"; ctx.fillStyle = "#d4a024"; ctx.font = "24px serif"; 
            ctx.fillText("âœ¦ Genshin Impact Musical Record âœ¦", w/2, h - 50);
        }

        function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
            ctx.beginPath(); ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y); ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius); ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height); ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius); ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath(); if (fill) ctx.fill(); if (stroke) ctx.stroke();
        }

        const shareBtn = document.getElementById('share-btn');
        const shareOverlay = document.getElementById('share-overlay');
        const qrDisplay = document.getElementById('qrcode-display');
        shareBtn.addEventListener('click', () => {
            const text = editor.innerText.trim();
            if (!text) return alert("è«‹å…ˆå¯«é»æ±è¥¿å†åˆ†äº«å–”ï¼âœ¦");
            if (window.location.protocol === 'file:') return alert("è«‹å°‡ç¶²é ä¸Šå‚³åˆ°ä¼ºæœå™¨æ‰èƒ½ä½¿ç”¨åˆ†äº«åŠŸèƒ½å–”ï¼");
            const encodedText = encodeURIComponent(text);
            const currentSize = fontSizeSlider.value;
            const shareUrl = `${window.location.origin}${window.location.pathname}?letter=${encodedText}&size=${currentSize}`;
            qrDisplay.innerHTML = ""; 
            new QRCode(qrDisplay, { text: shareUrl, width: 250, height: 250, colorDark: "#4a3b3b", colorLight: "#f4f3ea" });
            shareOverlay.style.display = 'flex';
        });
        function closeOverlay(id) { document.getElementById(id).style.display = 'none'; }
        
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const letterContent = params.get('letter');
            const sizeParam = params.get('size');
            if (letterContent) {
                const decodedText = decodeURIComponent(letterContent);
                if(sizeParam) editor.style.fontSize = sizeParam + 'px';
                document.getElementById('main-ui').style.display = 'none';
                document.getElementById('receiver-overlay').style.display = 'flex';
                document.getElementById('open-letter-btn').addEventListener('click', async () => {
                    document.getElementById('receiver-overlay').style.display = 'none';
                    document.getElementById('main-ui').style.display = 'flex';
                    document.getElementById('controls-container').style.display = 'none';
                    editor.setAttribute('contenteditable', 'false');
                    while(true) { await startAutoPlay(decodedText, 'receiver_loop'); await sleep(2500); }
                });
            }
        });

        document.getElementById('play-btn').addEventListener('click', () => startAutoPlay(editor.innerText));
        document.getElementById('genshin-card').addEventListener('click', () => { editor.focus(); });
    </script>
</body>
</html>
